#!/bin/bash
source logep.sh


export LOGSIZE="1024"

RUTA_ACTUAL=$PWD
while [[ $PWD != '/' && ${PWD##*/} != 'Grupo10' ]]
do
	cd ..
done

GRUPO=$PWD

ARCH_CONF=$PWD"/dirconf/Instalep.conf"
cd $RUTA_ACTUAL

if [ ! -e "$ARCH_CONF" ]
then
  echo "No existe el archivo de configuracion."
  echo "Presione ENTER para salir."
  read INPUT
  exit 0
fi

while read variable; do 

	IFS='=' read -a variablesConf <<< "$variable"
	if [ "${variablesConf[0]}" == 'DIRLOG' ]; then DIRLOG="${variablesConf[1]}"; fi
	if [ "${variablesConf[0]}" == "DIRBIN" ]; then DIRBIN="${variablesConf[1]}"; fi
	if [ "${variablesConf[0]}" == "DIRMAE" ]; then DIRMAE="${variablesConf[1]}"; fi
	if [ "${variablesConf[0]}" == "DIRREC" ]; then DIRREC="${variablesConf[1]}"; fi
	if [ "${variablesConf[0]}" == "DIROK" ]; then DIROK="${variablesConf[1]}"; fi
	if [ "${variablesConf[0]}" == "DIRPROC" ]; then DIRPROC="${variablesConf[1]}"; fi
	if [ "${variablesConf[0]}" == "DIRNOK" ]; then DIRNOK="${variablesConf[1]}"; fi	

done < $ARCH_CONF	

A_PROCESAR=$(ls $PWD | wc -l )
MENSAJE="Cantidad de archivos a procesar: $A_PROCESAR"

Logep $DIRLOG/Procep "$MENSAJE" WAR

CANTIDAD_PROCESADOS=0

for file in $DIROK/ejecutado_*
do

	if [ -f $DIRPROC/$(basename $file) ];
	then
		MENSAJE="Archivo Duplicado. Se rechaza el archivo $(basename $file)"

		cp $file $DIRNOK/$(basename $file)	

	 	Logep $DIRLOG/Procep "$MENSAJE" WAR
	else

		REGEX='^([0-9]*);([0-9]*);([0-9.\-]*);([A-Za-z 0-9]*);([A-Za-z 0-9]*);([0-9,]*)$'

		while read line; do 
		
			if [[ ! $line =~ $REGEX ]];
			then
				MENSAJE="Estructura inesperada. Se rechaza el archivo $(basename $file)."

				cp $file $DIRNOK/$(basename $file)

				Logep $DIRLOG/Procep "$MENSAJE" WAR
			else
				IFS=';' read -a columnas <<< "$line"

				if grep ${columnas[2]} $PWD:$DIRMAE/centros.csv
				then
				    echo "code if found"
				else
				    echo "code if not found"
				fi

				#Una vez procesado el archivo se copia a DIRPROC/proc
				cp $file $DIRPROC/$(basename $file)	
			fi

		echo -e "$line\n"; done < $file	
		
	fi
done

